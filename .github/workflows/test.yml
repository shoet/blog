on:
  push:
    branches:
      - "master"
  pull_request:

name: test

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      BLOG_ENV: ${{ secrets.BLOG_ENV }}
      BLOG_APP_PORT: ${{ secrets.BLOG_APP_PORT }}
      BLOG_AWS_S3_BUCKET: ${{ secrets.BLOG_AWS_S3_BUCKET }}
      BLOG_AWS_S3_THUMBNAIL_DIRECTORY: ${{ secrets.BLOG_AWS_S3_THUMBNAIL_DIRECTORY }}
      BLOG_AWS_S3_CONTENT_IMAGE_DIRECTORY: ${{ secrets.BLOG_AWS_S3_CONTENT_IMAGE_DIRECTORY }}
      ADMIN_NAME: ${{ secrets.ADMIN_NAME }}
      ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      BLOG_DB_HOST: 127.0.0.1
      BLOG_DB_PORT: 33061
      BLOG_DB_USER: blog
      BLOG_DB_PASS: blog
      BLOG_DB_NAME: blog
      BLOG_DB_TLS_ENABLED: false
      BLOG_KVS_HOST: localhost
      BLOG_KVS_PORT: 6379
      BLOG_KVS_USER: default
      BLOG_KVS_PASS: redispw
      BLOG_KVS_TLS_ENABLED: false

    services:
      mysql:
        image: mysql:8.0.33
        options: >-
          --health-cmd "mysqladmin ping -h localhost"
          --health-interval 20s
          --health-timeout 10s
          --health-retries 10
        ports:
          - 33061:3306
        env:
          MYSQL_ALLOW_EMPTY_PASSWORD: "yes"
          MYSQL_USER: ${{ secrets.BLOG_DB_USER }}
          MYSQL_PASSWORD: ${{ secrets.BLOG_DB_PASS }}
          MYSQL_DATABASE: ${{ secrets.BLOG_DB_NAME }}
      redis:
        image: redis:latest
        options: >-
          --health-cmd "redis-cli -h localhost ping"
          --health-interval 20s
          --health-timeout 10s
          --health-retries 10
        ports:
          - 6379:6379

    steps:
      - uses: actions/setup-go@v3
        with:
          go-version: ">=1.19"
      - uses: actions/checkout@v3
      # - run: |
      #     go install github.com/k0kubun/sqldef/cmd/mysqldef@latest
      #     mysqldef -u todo -p todo -h 127.0.0.1 -P 3306 todo < ./_tools/mysql/schema.sql
      - run: go test ./... -coverprofile=coverage.out
      - name: report coverage
        uses: k1LoW/octocov-action@v0
